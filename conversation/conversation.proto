// Copyright © 2023 OpenIM. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";
package openim.conversation;

import "sdkws/sdkws.proto";
import "wrapperspb/wrapperspb.proto";

option go_package = "github.com/openimsdk/protocol/conversation";

message Conversation {
  string ownerUserID = 1;
  string conversationID = 2;
  int32 recvMsgOpt = 3;
  int32 conversationType = 4;  // 会话类型: 1=单聊, 2=可写群聊, 3=只读群聊, 4=通知, 5=折叠会话
  string userID = 5;
  string groupID = 6;
  bool isPinned = 7;
  string attachedInfo = 8;
  bool isPrivateChat = 9;
  int32 groupAtType = 10;
  string ex = 11;
  int32 burnDuration = 12;
  int64 minSeq = 13;
  int64 maxSeq = 14;
  int64 msgDestructTime = 15;
  int64 latestMsgDestructTime = 16;
  bool isMsgDestruct = 17;
  bool isMark = 18;
  int32 unreadCount = 19;  // 手动设置的未读数，用于多设备同步
  int64 updateUnreadCountTime = 20;  // 手动更新未读数的时间戳（毫秒），用于多端同步时判断最新值
  string parentConversationID = 21;  // 父折叠会话ID，非空表示该会话被折叠（父会话conversationType=5）
}

message ConversationReq {
  string conversationID = 1;
  int32 conversationType = 2;  // 会话类型: 1=单聊, 2=可写群聊, 3=只读群聊, 4=通知, 5=折叠会话
  string userID = 3;
  string groupID = 4;
  openim.protobuf.Int32Value recvMsgOpt = 5;
  openim.protobuf.BoolValue isPinned = 6;
  openim.protobuf.StringValue attachedInfo = 7;
  openim.protobuf.BoolValue isPrivateChat = 8;
  openim.protobuf.StringValue ex = 9;
  openim.protobuf.Int32Value burnDuration = 10;
  openim.protobuf.Int64Value minSeq = 11;
  openim.protobuf.Int64Value maxSeq = 12;
  openim.protobuf.Int32Value groupAtType = 13;
  openim.protobuf.Int64Value msgDestructTime = 14;
  openim.protobuf.BoolValue isMsgDestruct = 15;
  openim.protobuf.BoolValue isMark = 16;
  openim.protobuf.Int32Value unreadCount = 17;  // 手动设置的未读数
  openim.protobuf.Int64Value updateUnreadCountTime = 18;  // 手动更新未读数的时间戳
  openim.protobuf.StringValue parentConversationID = 19;  // 父折叠会话ID
}

message SetConversationReq {
  Conversation conversation = 1;
}

message SetConversationResp {}

message GetConversationReq {
  string conversationID = 1;
  string ownerUserID = 2;
}

message GetConversationResp {
  Conversation conversation = 2;
}

message GetSortedConversationListReq {
  string userID = 1;
  repeated string conversationIDs = 2;
  sdkws.RequestPagination pagination = 3;
}

message GetSortedConversationListResp {
  int64 conversationTotal = 1;
  int64 unreadTotal = 2;
  repeated ConversationElem conversationElems = 3;
}

message ConversationElem {
  string conversationID = 1;
  int32 recvMsgOpt = 2;
  int64 unreadCount = 3;
  bool IsPinned = 4;
  MsgInfo msgInfo = 5;
}

message MsgInfo {
  string serverMsgID = 1;
  string clientMsgID = 2;
  int32 sessionType = 3;
  string sendID = 4;
  string recvID = 5;
  string senderName = 6;
  string faceURL = 7;
  string groupID = 8;
  string groupName = 9;
  string groupFaceURL = 10;
  int32 groupType = 11;
  uint32 groupMemberCount = 12;
  int64 LatestMsgRecvTime = 13;
  int32 msgFrom = 14;
  int32 contentType = 15;
  string content = 16;
  string ex = 17;
}

message GetConversationsReq {
  string ownerUserID = 1;
  repeated string conversationIDs = 2;
}

message GetConversationsResp {
  repeated Conversation conversations = 2;
}

message GetAllConversationsReq {
  string ownerUserID = 1;
}

message GetAllConversationsResp {
  repeated Conversation conversations = 2;
}

message GetRecvMsgNotNotifyUserIDsReq {
  string groupID = 1;
}

message GetRecvMsgNotNotifyUserIDsResp {
  repeated string userIDs = 1;
}

message CreateSingleChatConversationsReq {
  string recvID = 1;
  string sendID = 2;
  string conversationID = 3;
  int32 conversationType = 4;
}

message CreateSingleChatConversationsResp {}

message CreateGroupChatConversationsReq {
  repeated string userIDs = 1;
  string groupID = 2;
}

message CreateGroupChatConversationsResp {}

message SetConversationMaxSeqReq {
  string conversationID = 1;
  repeated string ownerUserID = 2;
  int64 maxSeq = 3;
}

message SetConversationMaxSeqResp {}

message SetConversationMinSeqReq {
  string conversationID = 1;
  repeated string ownerUserID = 2;
  int64 minSeq = 3;
}

message SetConversationMinSeqResp {}

message GetConversationIDsReq {
  string userID = 1;
}

message GetConversationIDsResp {
  repeated string conversationIDs = 1;
}

message SetConversationsReq {
  repeated string userIDs = 1;
  ConversationReq conversation = 2;
}

message SetConversationsResp {}

message GetUserConversationIDsHashReq {
  string ownerUserID = 1;
}

message GetUserConversationIDsHashResp {
  uint64 hash = 1;
}

message GetConversationsByConversationIDReq {
  repeated string conversationIDs = 1;
}

message GetConversationsByConversationIDResp {
  repeated Conversation conversations = 1;
}

message GetConversationOfflinePushUserIDsReq {
  string conversationID = 1;
  repeated string userIDs = 2;
}

message GetConversationOfflinePushUserIDsResp {
  repeated string userIDs = 1;
}

message GetConversationNotReceiveMessageUserIDsReq {
  string conversationID = 1;
}

message GetConversationNotReceiveMessageUserIDsResp {
  repeated string userIDs = 1;
}

message UpdateConversationReq {
  string conversationID = 1;
  repeated string userIDs = 2;
  openim.protobuf.Int32Value recvMsgOpt = 3;
  openim.protobuf.BoolValue isPinned = 4;
  openim.protobuf.StringValue attachedInfo = 5;
  openim.protobuf.BoolValue isPrivateChat = 6;
  openim.protobuf.StringValue ex = 7;
  openim.protobuf.Int32Value burnDuration = 8;
  openim.protobuf.Int64Value minSeq = 9;
  openim.protobuf.Int64Value maxSeq = 10;
  openim.protobuf.Int32Value groupAtType = 11;
  openim.protobuf.Int64Value msgDestructTime = 12;
  openim.protobuf.BoolValue isMsgDestruct = 13;
  openim.protobuf.Int64Value latestMsgDestructTime = 14;
  openim.protobuf.BoolValue isMark = 15;
  openim.protobuf.StringValue parentConversationID = 16;  // 父折叠会话ID
}

message UpdateConversationResp {}

message GetFullOwnerConversationIDsReq {
  uint64 idHash = 1;
  string userID = 2;
}

message GetFullOwnerConversationIDsResp {
  uint64 version = 1;
  string versionID = 2;
  bool equal = 3;
  repeated string conversationIDs = 4;
}

message GetIncrementalConversationReq {
  string userID = 1;
  string versionID = 2;
  uint64 version = 3;
}

message GetIncrementalConversationResp {
  uint64 version = 1;
  string versionID = 2;
  bool full = 3;
  repeated string delete = 4;
  repeated Conversation insert = 5;
  repeated Conversation update = 6;
}

message GetOwnerConversationReq {
  string userID = 1;
  openim.sdkws.RequestPagination pagination = 2;
}

message GetOwnerConversationResp {
  int64 total = 1;
  repeated Conversation conversations = 2;
}

message GetConversationsNeedClearMsgReq {}

message GetConversationsNeedClearMsgResp {
  repeated Conversation conversations = 1;
}

message GetNotNotifyConversationIDsReq {
  string userID = 1;
}

message GetNotNotifyConversationIDsResp {
  repeated string conversationIDs = 1;
}

message GetPinnedConversationIDsReq {
  string userID = 1;
}

message GetPinnedConversationIDsResp {
  repeated string conversationIDs = 1;
}

message MarkConversationReq {
  string userID = 1;
  string conversationID = 2;
  bool isMark = 3;
}

message MarkConversationResp {
  bool success = 1;
  string message = 2;
}

message MarkConversationAsUnreadReq {
  string userID = 1;
  string conversationID = 2;
  int32 unreadCount = 3;  // 设置的未读数
}

message MarkConversationAsUnreadResp {}

message ClearUserConversationMsgReq {
  int64 timestamp = 1;
  int32 limit = 2;
}
message ClearUserConversationMsgResp {
  int32 count = 1;
}

message UpdateConversationsByUserReq {
  string userID = 1;
  openim.protobuf.StringValue ex = 2;
}

message UpdateConversationsByUserResp {}

message DeleteConversationsReq {
  string ownerUserID = 1;
  int64 needDeleteTime = 2;
  repeated string conversationIDs = 3; // optional
}
message DeleteConversationsResp {}

// 会话分组
message ConversationGroup {
    string groupID = 1;
    string ownerUserID = 2;
    string groupName = 3;
    int32 groupType = 4;
    int32 sortOrder = 5;
    bool isVisible = 6;
    int64 createTime = 7;
    int64 updateTime = 8;
    string ex = 9;
}

message GroupOrder {
    string groupID = 1;
    int32 sortOrder = 2;
}

// 请求/响应消息
message InitConversationGroupsReq {
  string ownerUserID = 1;
}
message InitConversationGroupsResp {}

message GetAllConversationGroupsReq {
  string ownerUserID = 1;
}
message GetAllConversationGroupsResp {
  repeated ConversationGroup groups = 1;
}

message GetVisibleConversationGroupsReq {
  string ownerUserID = 1;
}
message GetVisibleConversationGroupsResp {
  repeated ConversationGroup groups = 1;
}

message CreateConversationGroupReq {
    string ownerUserID = 1;
    string groupName = 2;
    string groupID = 3;
    string ex = 4;
}
message CreateConversationGroupResp {
  ConversationGroup group = 1;
}

message UpdateConversationGroupReq {
    string groupID = 1;
    string groupName = 2;
    bool isVisible = 3;
    string ex = 4;
}
message UpdateConversationGroupResp {}

message DeleteConversationGroupReq {
  string groupID = 1;
}
message DeleteConversationGroupResp {}

message UpdateConversationGroupSortReq {
    string ownerUserID = 1;
    repeated GroupOrder groupOrders = 2;
}
message UpdateConversationGroupSortResp {}

message SetConversationGroupVisibilityReq {
    string groupID = 1;
    bool isVisible = 2;
}
message SetConversationGroupVisibilityResp {}

message AddConversationsToGroupReq {
    string ownerUserID = 1;
    string groupID = 2;
    repeated string conversationIDs = 3;
}
message AddConversationsToGroupResp {}

message RemoveConversationsFromGroupReq {
    string groupID = 1;
    repeated string conversationIDs = 2;
}
message RemoveConversationsFromGroupResp {}

message GetConversationIDsByGroupIDReq {
  string groupID = 1;
}
message GetConversationIDsByGroupIDResp {
  repeated string conversationIDs = 1;
}


service conversation {
  rpc GetConversation(GetConversationReq) returns (GetConversationResp);
  rpc GetSortedConversationList(GetSortedConversationListReq) returns (GetSortedConversationListResp);
  rpc GetAllConversations(GetAllConversationsReq) returns (GetAllConversationsResp);
  rpc GetConversations(GetConversationsReq) returns (GetConversationsResp);
  rpc SetConversation(SetConversationReq) returns (SetConversationResp);
  rpc GetRecvMsgNotNotifyUserIDs(GetRecvMsgNotNotifyUserIDsReq) returns (GetRecvMsgNotNotifyUserIDsResp);
  rpc CreateSingleChatConversations(CreateSingleChatConversationsReq) returns (CreateSingleChatConversationsResp);
  rpc CreateGroupChatConversations(CreateGroupChatConversationsReq) returns (CreateGroupChatConversationsResp);
  rpc SetConversationMaxSeq(SetConversationMaxSeqReq) returns (SetConversationMaxSeqResp);
  rpc SetConversationMinSeq(SetConversationMinSeqReq) returns (SetConversationMinSeqResp);
  rpc GetConversationIDs(GetConversationIDsReq) returns (GetConversationIDsResp);
  rpc SetConversations(SetConversationsReq) returns (SetConversationsResp);
  rpc GetUserConversationIDsHash(GetUserConversationIDsHashReq) returns (GetUserConversationIDsHashResp);
  rpc GetConversationsByConversationID(GetConversationsByConversationIDReq) returns (GetConversationsByConversationIDResp);
  rpc GetConversationOfflinePushUserIDs(GetConversationOfflinePushUserIDsReq) returns (GetConversationOfflinePushUserIDsResp);
  rpc GetConversationNotReceiveMessageUserIDs(GetConversationNotReceiveMessageUserIDsReq) returns (GetConversationNotReceiveMessageUserIDsResp);
  rpc UpdateConversation(UpdateConversationReq) returns (UpdateConversationResp);
  rpc GetFullOwnerConversationIDs(GetFullOwnerConversationIDsReq) returns (GetFullOwnerConversationIDsResp);
  rpc GetIncrementalConversation(GetIncrementalConversationReq) returns (GetIncrementalConversationResp);
  rpc GetOwnerConversation(GetOwnerConversationReq) returns (GetOwnerConversationResp);
  rpc GetConversationsNeedClearMsg(GetConversationsNeedClearMsgReq) returns (GetConversationsNeedClearMsgResp);
  rpc GetNotNotifyConversationIDs(GetNotNotifyConversationIDsReq) returns (GetNotNotifyConversationIDsResp);
  rpc GetPinnedConversationIDs(GetPinnedConversationIDsReq) returns (GetPinnedConversationIDsResp);
  rpc MarkConversation(MarkConversationReq) returns (MarkConversationResp);
  rpc MarkConversationAsUnread(MarkConversationAsUnreadReq) returns (MarkConversationAsUnreadResp);
  rpc ClearUserConversationMsg(ClearUserConversationMsgReq) returns (ClearUserConversationMsgResp);
  rpc UpdateConversationsByUser(UpdateConversationsByUserReq) returns (UpdateConversationsByUserResp);
  rpc DeleteConversations(DeleteConversationsReq) returns (DeleteConversationsResp);
  rpc InitConversationGroups(InitConversationGroupsReq) returns (InitConversationGroupsResp);
  rpc GetAllConversationGroups(GetAllConversationGroupsReq) returns (GetAllConversationGroupsResp);
  rpc GetVisibleConversationGroups(GetVisibleConversationGroupsReq) returns (GetVisibleConversationGroupsResp);
  rpc CreateConversationGroup(CreateConversationGroupReq) returns (CreateConversationGroupResp);
  rpc UpdateConversationGroup(UpdateConversationGroupReq) returns (UpdateConversationGroupResp);
  rpc DeleteConversationGroup(DeleteConversationGroupReq) returns (DeleteConversationGroupResp);
  rpc UpdateConversationGroupSort(UpdateConversationGroupSortReq) returns (UpdateConversationGroupSortResp);
  rpc SetConversationGroupVisibility(SetConversationGroupVisibilityReq) returns (SetConversationGroupVisibilityResp);
  rpc AddConversationsToGroup(AddConversationsToGroupReq) returns (AddConversationsToGroupResp);
  rpc RemoveConversationsFromGroup(RemoveConversationsFromGroupReq) returns (RemoveConversationsFromGroupResp);
  rpc GetConversationIDsByGroupID(GetConversationIDsByGroupIDReq) returns (GetConversationIDsByGroupIDResp);
  
  // 会话折叠相关接口（折叠会话模式）
  rpc CreateFoldConversation(CreateFoldConversationReq) returns (CreateFoldConversationResp);  // 创建折叠会话
  rpc UpdateFoldInfo(UpdateFoldInfoReq) returns (UpdateFoldInfoResp);  // 更新折叠属性
  rpc GetFoldInfo(GetFoldInfoReq) returns (GetFoldInfoResp);  // 获取折叠属性
  rpc SetConversationFold(SetConversationFoldReq) returns (SetConversationFoldResp);  // 将会话放入/移出折叠
  rpc GetFoldConversationList(GetFoldConversationListReq) returns (GetFoldConversationListResp);  // 获取折叠内的会话列表
  rpc GetAllFolds(GetAllFoldsReq) returns (GetAllFoldsResp);  // 获取所有折叠会话列表
  rpc GetFoldDetail(GetFoldDetailReq) returns (GetFoldDetailResp);  // 获取折叠详情
  rpc PinFold(PinFoldReq) returns (PinFoldResp);  // 折叠置顶
  rpc SetFoldRecvMsgOpt(SetFoldRecvMsgOptReq) returns (SetFoldRecvMsgOptResp);  // 设置折叠免打扰
  rpc RemoveFold(RemoveFoldReq) returns (RemoveFoldResp);  // 删除折叠
}

// 会话折叠相关消息定义
// SetConversationFold 将会话放入/移出折叠
// 操作：设置会话的 parentConversationID 字段
message SetConversationFoldReq {
  string conversationID = 1;           // 要折叠的会话ID
  string parentConversationID = 2;     // 父折叠会话ID，空字符串表示移回正常列表
}

message SetConversationFoldResp {}

// GetFoldConversationList 获取折叠内的会话列表
// 查询 parentConversationID = foldConversationID 的所有会话
message GetFoldConversationListReq {
  string userID = 1;
  string foldConversationID = 2;      // 折叠会话ID（也就是子会话的parentConversationID）
  openim.sdkws.RequestPagination pagination = 3;
}

message GetFoldConversationListResp {
  int64 total = 1;
  repeated Conversation conversations = 2;
}

message GetAllFoldsReq {
  string userID = 1;
  int32 foldType = 2;  // 折叠类型: 0=获取所有, 1=普通折叠, 2=通知折叠
}

// ConversationFold 折叠会话属性（类似Group表，存储折叠会话的扩展属性）
// foldConversationID 与 conversation 表的 conversationID 关联（当 conversationType=5 时）
message ConversationFold {
  string foldConversationID = 1;     // 折叠会话ID（与conversation表的conversationID关联）
  string ownerUserID = 2;            // 用户ID
  string foldName = 3;               // 折叠名称
  string faceURL = 4;                // 头像URL
  string description = 5;            // 描述
  int32 foldType = 6;                // 折叠类型: 1=普通折叠, 2=通知折叠
  int32 sortOrder = 7;               // 排序顺序
  int64 createTime = 8;              // 创建时间
  int64 updateTime = 9;              // 更新时间
  string ex = 10;                    // 扩展字段
}

// FoldInfo 折叠信息（带统计数据，用于列表展示）
message FoldInfo {
  string foldConversationID = 1;     // 折叠会话ID
  string foldName = 2;               // 折叠名称
  string faceURL = 3;                // 头像URL
  string description = 4;            // 描述
  int32 foldType = 5;                // 折叠类型: 1=普通折叠, 2=通知折叠
  int64 conversationCount = 6;       // 分组内的会话数量
  int32 unreadCount = 7;             // 分组内的未读消息总数
  int64 latestMsgTime = 8;           // 分组内最后一条消息的时间
  bool isPinned = 9;                 // 是否置顶（来自折叠会话）
  int32 recvMsgOpt = 10;             // 接收消息选项（来自折叠会话）
  bool isSystemDefault = 11;         // 是否为系统默认分组
  int32 sortOrder = 12;              // 排序顺序
}

message GetAllFoldsResp {
  repeated FoldInfo groups = 1;
}

message GetFoldDetailReq {
  string userID = 1;
  string foldConversationID = 2;  // 折叠会话ID
  openim.sdkws.RequestPagination pagination = 3;
}

message GetFoldDetailResp {
  int64 total = 1;
  int32 unreadTotal = 2;           // 未读总数
  repeated Conversation conversations = 3;
}

message PinFoldReq {
  string userID = 1;
  string foldConversationID = 2;  // 折叠会话ID
  bool isPinned = 3;              // true=置顶, false=取消置顶
}

message PinFoldResp {}

message SetFoldRecvMsgOptReq {
  string userID = 1;
  string foldConversationID = 2;  // 折叠会话ID
  int32 recvMsgOpt = 3;           // 接收消息选项：0=接收消息, 1=不接收消息, 2=接收消息但不通知（免打扰）
}

message SetFoldRecvMsgOptResp {}

// GetFoldInfo 获取折叠属性
message GetFoldInfoReq {
  string userID = 1;
  string foldConversationID = 2;   // 折叠会话ID
}

message GetFoldInfoResp {
  ConversationFold fold = 1;       // 折叠属性
}

message RemoveFoldReq {
  string userID = 1;
  string foldConversationID = 2;  // 要移除的折叠会话ID
}

message RemoveFoldResp {
  int32 movedCount = 1;            // 移回的会话数量
}

// CreateFoldConversation 创建折叠会话（同时创建折叠会话和折叠属性）
message CreateFoldConversationReq {
  string userID = 1;               // 用户ID
  string foldName = 2;             // 折叠名称
  string faceURL = 3;              // 头像URL
  string description = 4;          // 描述
  int32 foldType = 5;              // 折叠类型: 1=普通折叠, 2=通知折叠
}

message CreateFoldConversationResp {
  string foldConversationID = 1;   // 创建的折叠会话ID（同时也是fold表的关联ID）
}

// UpdateFoldInfo 更新折叠属性（不更新会话本身）
message UpdateFoldInfoReq {
  string userID = 1;                           // 用户ID
  string foldConversationID = 2;               // 折叠会话ID
  openim.protobuf.StringValue foldName = 3;    // 折叠名称（可选）
  openim.protobuf.StringValue faceURL = 4;     // 头像URL（可选）
  openim.protobuf.StringValue description = 5; // 描述（可选）
}

message UpdateFoldInfoResp {}
